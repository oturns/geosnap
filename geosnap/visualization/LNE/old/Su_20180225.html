<!DOCTYPE html> 
<html>
<head>
	<title>Longitudinal Neighborhood Analysis</title>
	
	<script src="jQuery/jquery-3.3.1.js"></script>
	<script src="d3/d3.min.js"></script>
	<link rel="stylesheet" href="leaflet/leaflet.css" />
	<script src="leaflet/leaflet.js"></script>
	<script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
	<!--link rel="stylesheet" href="dist/leaflet.css" /-->
	<!--[if lte IE 8]><link rel="stylesheet" href="../../dist/leaflet.ie.css" /><![endif]-->
	<link rel="stylesheet" href="css/screen.css" />

	<style>
		#map0 {
			width: 1200px;
			height: 800px;
		}
		header {background:white; color:black; height:50px;}
		//input_year {background: red;color:black; height:50px;}
		//input_state {background: red;color:black; height:50px;}			
		//section {background: green; height:820px; }
		//section {background: white; height:820px; }
		//footer {background:red; height:820px;}
		footer {background:white; height:680px;}
		.info {
			padding: 6px 8px;
			font: 14px/16px Arial, Helvetica, sans-serif;
			background: white;
			background: rgba(255,255,255,0.8);
			box-shadow: 0 0 15px rgba(0,0,0,0.2);
			border-radius: 5px;
		}
		.info h4 {
			margin: 0 0 5px;
			color: #777;
		}

		.legend {
			text-align: left;
			line-height: 18px;
			color: #555;
		}
		.legend i {
			width: 18px;
			height:15px;
			float: left;
			margin-right: 8px;
			opacity: 0.7;
		}
		
		html {
		font-family: sans-serif;
		}
		
		//form {
		//width: 280px;
		//margin: 0 auto;
		//}
		
		//div {
		//margin-bottom: 10px;
		//}
		
		fieldset {
		background: white;
		border: 2px solid grey;
		}
		
		legend {
			padding: 10px;
			font-size:medium;
			background: grey;
			color: white;
		}

		.quadrbox{
			width: 310px;
			margin: 0 auto;
		}
		
		#input_area_box1 {
			width: 320px;
			//height:760px;
			//background-color:#FFFACD;
			margin-bottom: 10px;
			font-size:small;
			float: left;
		}
		#input_area_box2 {
			width: 320px;
			//height:760px;
			//background-color:#F0FFFF;
			margin-bottom: 10px;
			font-size:small;
			float: left;
		}
		#input_area_box3 {
			width: 320px;
			//height:760px;
			//background-color:#D8BFD8;
			margin-bottom: 10px;
			font-size:small;
			float: left;
		}	
		#input_area_box4 {
			width: 320px;
			//height:760px;
			//background-color:#FFFACD;
			margin-bottom: 10px;
			font-size:small;
			float: left;
		}

		#ajaxBusy {
			display: none;
			margin: 0px 0px 0px -50px; /* left margin is half width of the div, to centre it */
			padding: 30px 10px 10px 10px;
			position: absolute;
			left: 30%;
			top: 325px;
			width: 500px;
			height: 500px;
			text-align: center;
			//background-color:#9ACD32;
			//background: #e8e8e8 url(images/ajax-loader.gif) no-repeat center center;
			background: url(images/ajax_loader_blue_350.gif) no-repeat center center;
			border: 0px solid #000;
		}

		.clearfix:after { contnt:"."; display:block; visibility:hidden; height:0; clear:both; }
		.clearfix { display: inline-block; }

	</style>

	<!--script src="debug/leaflet-include.js"></script-->
</head>


<body>

	<header>
		<h1>Longitudinal Neighborhood Analysis</h1>		
	</header>
	
	</br></br>
	<section class="clearfix">
	<div id="input_year" style="width:150px; height:20px; padding:10px; float:left; background-color:white; ">
		<form name="YearSelect" action="">
			<span>Select Year: </span>
			<select name="year" onChangeX="layerChange1()">			
				<option value="1970" >1970</option>
				<option value="1980">1980</option>
				<option value="1990">1990</option>
				<option value="2000" >2000</option>
				<option value="2010" >2010</option>				
			</select>
		</form>
	</div>	
	
	<div id="input_state" style="width:210px;height:20px; padding:10px;float:left; background-color:white;">
		<form name="state_select" action="">
			<span>State:</span>
			<select name="state">			
				<option value="01 AL">ALABAMA</option>
				<option value="02 AK">ALASKA</option>
				<option value="04 AZ">ARIZONA</option>
				<option value="05 AR">ARKANSAS</option>
				<option value="06 CA">CALIFORNIA</option>
				<option value="08 CO">COLORADO</option>
				<option value="09 CT">CONNECTICUT</option>
				<option value="10 DE">DELAWARE</option>
				<option value="11 DC">DC</option>
				<option value="12 FL">FLORIDA</option>
				<option value="13 GA">GEORGIA</option>
				<option value="15 HI">HAWAII</option>
				<option value="16 ID">IDAHO</option>
				<option value="17 IL">ILLINOIS</option>
				<option value="18 IN">INDIANA</option>
				<option value="19 IA">IOWA</option>
				<option value="20 KS">KANSAS</option>
				<option value="21 KY">KENTUCKY</option>
				<option value="22 LA">LOUISIANA</option>
				<option value="23 ME">MAINE</option>
				<option value="24 MD">MARYLAND</option>
				<option value="25 MA">MASSACHUESTTS</option>
				<option value="26 MI">MICHIGAN</option>
				<option value="27 MN">MINNESOTA</option>
				<option value="28 MS">MISSISSIPPI</option>
				<option value="29 MO">MISSOURI</option>
				<option value="30 MT">MONTANA</option>
				<option value="31 NE">NEBRASKA</option>
				<option value="32 NV">NEVADA</option>
				<option value="33 NH">NEW HAMPSHIRE</option>
				<option value="34 NJ">NEW JERSEY</option>
				<option value="35 NM">NEW MEXICO</option>
				<option value="36 NY">NEW YORK</option>
				<option value="37 NC">NORTH CAROLINA</option>
				<option value="38 ND">NORTH DAKOTA</option>
				<option value="39 OH">OHIO</option>
				<option value="40 OK">OKLAHOMA</option>
				<option value="41 OR">OREGON</option>
				<option value="42 PA">PENNSYLVANIA</option>
				<option value="44 RI">RHODE ISLAND</option>
				<option value="45 SC">SOUTH CAROLINA</option>
				<option value="46 SD">SOUTH DAKAOTA</option>
				<option value="47 TN">TENNESSEE</option>
				<option value="48 TX">TEXAS</option>
				<option value="49 UT">UTAH</option>
				<option value="50 VT">VERMONT</option>
				<option value="51 VA">VIRGINIA</option>
				<option value="53 WA">WASHINGTON</option>
				<option value="54 WV">WEST VIRGINIA</option>
				<option value="55 WI">WISCONSIN</option>
				<option value="56 WY">WYOMING</option>
				<option value="72 PR">PR</option>				
			</select>
		</form>
	</div>

	<div id="option-2nd" style="background-color:white;width:800px;height:40px; float:left; border: 1px solid #99CCFF; border-radius: 5px; ">
		<div id="input_metro" style="width:400px;height:20px; padding:10px;float:left; background-color:transparent;">
			<form name="metro_select" action="">
				<span>Metro Area:  </span>
				<select name="metro">			
					<option value="ALL">All county of ALABAMA</option>
					<option value="10700">Albertville</option>
					<option value="11500">Anniston-Oxford-Jacksonville</option>
					<option value="12220">Auburn-Opelika</option>
					<option value="13820">Birmingham-Hoover</option>
					<option value="17980">Columbus</option>
					<option value="18980">Cullman</option>
					<option value="19300">Daphne-Fairhope-Foley</option>
					<option value="19460">Decatur</option>
					<option value="20020">Dothan</option>
					<option value="21460">Enterprise</option>
					<option value="22520">Florence-Muscle Shoals</option>
					<option value="23460">Gadsden</option>
					<option value="26620">Huntsville</option>
					<option value="33660">Mobile</option>
					<option value="33860">Montgomery</option>
					<option value="37120">Ozark</option>
					<option value="42460">Scottsboro</option>
					<option value="42820">Selma</option>
					<option value="45180">Talladega-Sylacauga</option>
					<option value="45980">Troy</option>
					<option value="46220">Tuscaloosa</option>
					<option value="46740">Valley</option>
				</select>
			</form>
		</div>

		<div id="input_county" style="width:300px;height:20px; padding:10px;float:left; background-color:transparent;">
			<form name="county_select" action="" >
				<span>County: </span>
				<select name="county">	
					<option value="ALL" >ALL</option>				
					<option value="01007" >Bibb</option>
					<option value="01009" >Blount</option>
					<option value="01021" >Chilton</option>
					<option value="01073" >Jefferson</option>
					<option value="01115" >St. Clair</option>
					<option value="01117" >Shelby</option>
					<option value="01127" >Walker</option>					
				</select>
			</form>
		</div> 

		<div id="help" style="width:20px;height:20px; padding:10px;float:left; background-color:transparent;">
			<a href= "http://sarasen.asuscomm.com/neighborhood/pick_POI.html" target="_blank">help?</a>
		</div>
		
	</div>	
	</section>

	</br></br></br>	
	<section class="clearfix">
		<div id="input_area_box1">
			<form class=quadrbox>
			<fieldset id="input_area_fieldset1">
			<legend>Race, Age by Race</legend>
				<div id="input_area_items1">
				<div>
					<input type="checkbox" id="input_area1_check0" name="input_area1__checkboxes" value="ALL">
					<label for="input_area1_check0"> ALL</label></div>
				<div>
					<input type="checkbox" id="input_area1_check1" name="input_area1_checkboxes" value="1-01 nhwhtXX">
					<label for="input_area1_check1"> % white, non-Hispanic</label></div>
				<div>
					<input type="checkbox" id="input_area1_check2" name="input_area1_checkboxes" value="1-02 nhblkXX">
					<label for="input_area1_check2"> % black, non-Hispanic</label></div>
				<div>
					<input type="checkbox" id="input_area1_check3" name="input_area1_checkboxes" value="1-03 hispXX">
					<label for="input_area1_check3"> % black, non-Hispanic</label></div>
				
				</div>	
			</fieldset>
			</form>
		</div>
	
		<div id="input_area_box2">
			<form class=quadrbox>
			<fieldset id="input_area_fieldset2">
			<legend>Ethnicity and Immigration</legend>
				<div id="input_area_items2">
				<div>
					<input type="checkbox" id="input_area2_check0" name="input_area2_checkboxes" value="ALL">
					<label for="input_area1_check0"> ALL</label></div>
				<div>
					<input type="checkbox" id="input_area2_check1" name="input_area2_checkboxes" value="2-01 mexXX">
					<label for="input_area2_check1"> % Mexican birth/ethnicity</label></div>
				<div>
					<input type="checkbox" id="input_area2_check2" name="input_area2_checkboxes" value="2-02 cubanXX">
					<label for="input_area2_check2"> % Cuban birth/ethnicity</label></div>
				<div>
					<input type="checkbox" id="input_area2_check3" name="input_area2_checkboxes" value="2-03 prXX">
					<label for="input_area2_check3"> #% Puerto Rican birth/ethnicity</label></div>
					
				</div>			
			</fieldset>
			</form>
		</div>
		
		<div id="input_area_box3">
			<form class=quadrbox>
			<fieldset id="input_area_fieldset3">
			<legend>Socioeconomic Status</legend>
				<div id="input_area_items3">
				<div>
					<input type="checkbox" id="input_area3_check0" name="input_area3_checkboxes" value="ALL">
					<label for="input_area1_check0"> ALL</label></div>
				<div>
					<input type="checkbox" id="input_area3_check1" name="input_area3_checkboxes" value="3-01 hsXX">
					<label for="input_area3_check1"> % with high school degree or less</label></div>
				<div>
					<input type="checkbox" id="input_area3_check2" name="input_area3_checkboxes" value="3-02 colXX">
					<label for="input_area3_check2"> % with 4-year college degree or more</label></div>
				<div>
					<input type="checkbox" id="input_area3_check3" name="input_area3_checkboxes" value="3-03 unempXX">
					<label for="input_area3_check3"> % unemployed</label></div>
	
				</div>			
			</fieldset>
			</form>
		</div>

		<div id="input_area_box4">
			<form class=quadrbox>
			<fieldset id="input_area_fieldset4">
			<legend>Housing, Age, and Marital Status</legend>
				<div id="input_area_items4">
				<div>
					<input type="checkbox" id="input_area4_check0" name="input_area4_checkboxes" value="ALL">
					<label for="input_area1_check0"> ALL</label></div>
				<div>
					<input type="checkbox" id="input_area4_check1" name="input_area4_checkboxes" value="4-01 vacXX">
					<label for="input_area4_check1"> % vacant units</label></div>
				<div>
					<input type="checkbox" id="input_area4_check2" name="input_area4_checkboxes" value="4-02 ownXX">
					<label for="input_area4_check2"> % owner-occupied units</label></div>
				<div>
					<input type="checkbox" id="input_area4_check3" name="input_area4_checkboxes" value="4-03 multiXX">
					<label for="input_area4_check3"> % multi-family units</label></div>
	
				</div>
			</fieldset>
			</form>
		</div>

	</section>
	
	<br><br>
	<section>
	<!--div id="buttons" style="background-color:#ffffff;height:30px;widthx:0px;float:left;">
		<button type="submit" style="float:left">Submit form</button>
		<button id="downloadCSV" type="submit" style="float:left">Download CSV</button>
	</div-->
	<div style="float:left; height:40px;background-color:transparent; width:1270px;">
		<button type="submit" id="submitForm" style="float:left">Submit form</button>
		<button type="submit" id="downloadCSV" style="float:right">Download CSV</button>
	</div>
	<br>
	<div id="input_selected" style=" width:1270px;background-color:transparent"></div>

	</section>
	
	<br><br>
	<footer>
		<div>
		
		
		</div>
		</br>
	
	<div id="map_change" style="background-color:transparent;height:30px;width:490px;float:left;"></div>
	<div id="map_class" style="background-color:#ffffff;height:30px;width:800px;float:left;"></div>	
	<br><br><br><br>	
	<div id="example_map" style=" width:1270px;background-color:transparent"></div>			
			
		</br>
		<div id="map0"></div>
 	</footer>         		


	<script type="text/javascript" src="js/CA_ACS11.js"></script>
	<script type="text/javascript" src="js/Poverty70.js"></script>	
	<script type="text/javascript">

		var map = null;
		var geojson = null;
		var info    = null;
		var legend  = null;
		
//global varible
var app={
	year: null,                                  // global variable for the selected year from the user
	state: null,                                 // global variable for the selected state from the user
	metro: null,                                 // global variable for the selected metro from the user
	county: null,                                // global variable for the selected county from the user
	states: null,                                // global area for the contents of states table from server
	groups: null,                                // global area for the contents of groups table from server
	codebook: null,                              // global area for the contents of codebook table from server
};
/*
		var map = L.map('map').setView([37.746, -122.338], 10);

		var cloudmade = L.tileLayer('http://{s}.tile.cloudmade.com/{key}/{styleId}/256/{z}/{x}/{y}.png', {
			//attribution: 'Map data &copy; 2011 OpenStreetMap contributors, Imagery &copy; 2011 CloudMade',
			key: 'BC9A493B41014CAABB98F0471D759707',
			styleId: 998
		}).addTo(map);
*/

/*
	//var map = L.map('map').setView([34.0522, -118.2437], 10);
	var map = L.map('map0').setView([37.09024, -95.712891], 4);
			L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
				maxZoom: 20,
				attribution:'<a href="http://spatial.ucr.edu/">Center for Geospatial Sciences</a>, ',
				id: 'mapbox.light'
			}).addTo(map);	


		var layersControl = new L.Control.Layers({
			//'CloudMade': cloudmade
		}, {
			//'Some marker': marker,
			//'vector layer': geojson
		});	

		//map.addControl(layersControl);		   
*/
		//sync_mapbound();
function sync_mapbound() {
	map.fitBounds([
		[23.94, -126],
		[49.34, -75]
	//	[40.712, -74.227],
	//	[40.774, -74.125]
	]);

}

		
function remove(){
	//if (geojson != null) map.removeLayer(geojson);
	if (map.hasLayer(geojson)) map.removeLayer(geojson);
	//if (info    != null) info.removeFrom(map);
	if (info    != null) info.remove();
	//if (legend  != null) legend.removeFrom(map);
	if (legend  != null) legend.remove();	
}
/*
		function styleRemove(feature) {
			return {
				//weight: 2,
				opacity: 0,
				color: 'white',
				//dashArray: '3',
				fillOpacity: 0,
				fillColor: 'white'
			};
		}
*/		

function layerChange() {

  	//var selectedLayer  = document.layerSelect.ACSdata.value;
	var selectedLayer  = $("select[name=ACSdata] option:selected").val();
	//var classification = document.classSelect.classified.value;
	var classification = $("select[name=classified] option:selected").val();
	
	//var layers = ["poverty70", "poverty80", "poverty90", "poverty00", "poverty10"];
	var selectedLayerIndex  = $("select[name=ACSdata]").prop('selectedIndex');
	//selectedLayer = layers[selectedLayerIndex % layers.length]

	console.log(selectedLayerIndex, selectedLayer, classification);
	//selectedLayer = selectedLayer.split(" ")[1]
	parm = selectedLayer.split(" ")[1]
	selectedLayer = parm.substring(0, parm.length-2) + app.year.substring(2,4);
	console.log(selectedLayerIndex, selectedLayer, classification);
		
	if (classification == "equal") {
	
		var min = Number.MAX_VALUE; 
		var max = Number.MIN_VALUE;
		for (var i=0; i<CA.features.length; i++){
			if (CA.features[i].properties[selectedLayer] == -9999) continue;
			if (min > CA.features[i].properties[selectedLayer]) min = CA.features[i].properties[selectedLayer];
			if (max < CA.features[i].properties[selectedLayer]) max = CA.features[i].properties[selectedLayer];
		}
		//alert(selectedLayer + " " + min + " " + max);
		
		var range = max - min;
		var interval = range / 8;
		var intervals = new Array();
		//intervals[0] = Math.round(min);
		intervals[0] = min;
		for (var i=1; i<8; i++) {
			//intervals[i] = Math.round(intervals[i-1] + interval);
			intervals[i] = intervals[i-1] + interval;
		}
		for (var i=0; i<intervals.length; i++) {
			intervals[i] = intervals[i].toFixed(2);
		}
		//alert(intervals[0]+" "+intervals[1]+" "+intervals[2]+" "+intervals[3]+" "+intervals[4]+" "+intervals[5]+" "+intervals[6]+" "+intervals[7]);
		ACSdata_render(selectedLayer, intervals);
	}
	
	if (classification == "quantile") {
			
		var values = new Array();
		var j=0;
		for (var i=0; i<CA.features.length; i++) {
			if (CA.features[i].properties[selectedLayer] == -9999) continue;
			values[j++] = CA.features[i].properties[selectedLayer];
		}
		values.sort(function(a,b){return a-b});
		var interval = values.length / 8;
		
		var intervals = new Array();
		var next_interval = 0;
		intervals[0] = Math.round(values[0]);
		for (var i=1; i<8; i++) {
			next_interval += interval;
			j = Math.round(next_interval);
			//intervals[i] = values[j];
			intervals[i] = values[j].toFixed(2);
		}
		//alert(selectedLayer+"  "+intervals[0]+" "+intervals[1]+" "+intervals[2]+" "+intervals[3]+" "+intervals[4]+" "+intervals[5]+" "+intervals[6]+" "+intervals[7]);
		ACSdata_render(selectedLayer, intervals);
	}

	
}

function ACSdata_render(item, intervals) {

        // clear a layer and two controls
		//remove();
		
		// control that shows state info on hover
		if (info != null) info.remove();
		info = L.control();
		info.onAdd = function (map) {
			this._div = L.DomUtil.create('div', 'info');
			this.update();
			return this._div;
		};
		info.update = function (props) {
			this._div.innerHTML = '<h4></h4>' +  (props ?
				'<b>'  + '</b>' + ' ' + props[item] + '<br/><br/>'
				+'<h4>tract id (area)</h4>'
				+ props.tractid
				: 'Hover over an area');
		};
		info.addTo(map);


		// get color depending on population density value
		function getColor1(d) {
			var color = ["#FFEDA0","#FED976","#FEB24C","#FD8D3C","#FC4E2A","#E31A1C","#BD0026","#800026"];
			for (var i=color.length-1; i>=0; i--) {
				//if (d >= intervals[i]) return color[i];
				if (d == "-9999") return "#5E5E5E";
				if (d >= intervals[i]) {
					//alert(d+" color["+i+"]="+color[i]);
					return color[i];
				}
			}	
		}
		
		function style1(feature) {
			return {
				weight: 1,
				opacity: 1,
				color: 'white',
				dashArray: '1',
				fillOpacity: 0.5,
				fillColor: getColor1(feature.properties[item])
			};
		}

		function highlightFeature(e) {
			var layer = e.target;
			layer.setStyle({
				weight: 5,
				color: '#666',
				dashArray: '',
				fillOpacity: 0.7
			});
			if (!L.Browser.ie) {
				layer.bringToFront();
			}
			info.update(layer.feature.properties);
		}

		function resetHighlight(e) {
			geojson.resetStyle(e.target);
			info.update();
		}

		function zoomToFeature(e) {
			map.fitBounds(e.target.getBounds());
		}

		function onEachFeature(feature, layer) {
			layer.on({
				mouseover: highlightFeature,
				mouseout: resetHighlight,
				click: zoomToFeature
				//click: highlightFeature
			});
		}

		// layer that shows data
		if (map.hasLayer(geojson)) map.removeLayer(geojson);
		geojson = L.geoJson(CA, {
			style: style1,
			onEachFeature: onEachFeature
		}).addTo(map);

		map.attributionControl.addAttribution('Population data &copy; <a href="http://census.gov/">US Census Bureau</a>');

		// control that shows legend
		if (legend != null) legend.remove();
		legend = L.control({position: 'bottomright'});

		legend.onAdd = function (map) {

			var div = L.DomUtil.create('div', 'info legend'),
				//grades = [0, 13559    , 27118    , 40677    , 54236   , 67795   , 81354   , 94913  ],     // var
				grades = intervals,
				labels = [],
				from, to;

			for (var i = 0; i < grades.length; i++) {
				from = grades[i];
				to = grades[i + 1];

				labels.push(
					'<i style="background:' + getColor1(from + 1) + '"></i> ' +
					from + (to ? '&ndash;' + to : '+'));
			}
			labels.push(    // last legend is always 'Data not shown'
					'<i style="background:' + getColor1('-9999') + '"></i> ' +
					'No Data');				
			div.innerHTML = labels.join('<br>');
			return div;
		};

		legend.addTo(map);
}

/*
	var otherCheckbox = document.querySelector('input[value="other"]');
	var otherText = document.querySelector('input[id="otherValue"]');
	otherText.style.visibility = 'hidden';
	
	otherCheckbox.onchange = function() {
	if(otherCheckbox.checked) {
		otherText.style.visibility = 'visible';
		otherText.value = '';
	} else {
		otherText.style.visibility = 'hidden';
	}
	};
*/


$( document ).ready(function() {
	// Set up the AJAX indicator
    $('body').append('<div id="ajaxBusy"><p id="ajaxBusyMsg">Please wait...</p></div>');
	
	app.year = $("select[name=year]").val();     // save year to global variable
	$("select[name=year]").change(function(){
		app.year = $(this).val();                // save year to global variable, if changed
		console.log("app.year changed: " + app.year)
		changeLabelColor_quadrbox();
	});
	
	app.state = $("select[name=state]").val();  // save state to global variable
	$("select[name=state]").change(function(){
		app.state = $(this).val();               // save state to global variable, if changed
		console.log("app.state changed: " + app.state)
		set_metro_options();
		//set_county_options()
	});
	
	app.metro = $("select[name=metro]").val();  // save metro to global variable
	$("select[name=metro]").change(function(){
		app.metro = $(this).val();              // save metro to global variable, if changed
		console.log("app.metro changed: " + app.metro)
		set_county_options()
	});
	
	app.county = $("select[name=county]").val();  // save county to global variable
	$("select[name=county]").change(function(){
		app.county = $(this).val();              // save county to global variable, if changed
		console.log("app.county changed: " + app.county)
	});
	
	$("#ajaxBusy").show();
	$.getJSON('python/getCodebook.py', {}, function(msg) {
		$("#ajaxBusy").hide();
		
		app.states = msg['states']               // save states table to global variable
		app.groups = msg['groups']               // save groups table to global variable
		app.codebook = msg['codebook']           // save codebook to global variable
		
		// process states table from server
		var html = '';
		// row: ["06", "CA", null]  ->  <option value="06 CA">CA or California</option>
		$.each(app.states, function(idx, row) {  
			var stateid = row[0];
			var state = row[1];
			var statename = row[2];
			var text = (statename) ? statename : state
			html += '<option value="' + stateid + ' ' + state + '">' + text + '</option>';
		});
		$("select[name=state]").html(html);
		//console.log($("select[name=state]").html());
		
		set_metro_options();
		//set_county_options()
		
		// process groups and codebook table from server
		var p_serial = app.codebook[0].indexOf('serial');
		var p_code = app.codebook[0].indexOf('code');
		var p_descritpion = app.codebook[0].indexOf('descritpion');
		var p_year1970 = app.codebook[0].indexOf('year1970');
		var p_year1980 = app.codebook[0].indexOf('year1980');
		var p_year1990 = app.codebook[0].indexOf('year1990');
		var p_year2000 = app.codebook[0].indexOf('year2000');
		var p_year2010 = app.codebook[0].indexOf('year2010');
		var p_year2012 = app.codebook[0].indexOf('year2012');
		var p_groupid = app.codebook[0].indexOf('groupid');
		var p_web_system = app.codebook[0].indexOf('web_system');
		var p_description_short_name = app.codebook[0].indexOf('description_short_name');
		var p_description_full_name = app.codebook[0].indexOf('description_full_name');
		var p_denominator1970 = app.codebook[0].indexOf('denominator1970');
		var p_denominator1980 = app.codebook[0].indexOf('denominator1980');
		var p_denominator1990 = app.codebook[0].indexOf('denominator1990');
		var p_denominator2000 = app.codebook[0].indexOf('denominator2000');
		var p_denominator2010 = app.codebook[0].indexOf('denominator2010');
		var p_denominator2012 = app.codebook[0].indexOf('denominator2012');
		
		$.each(app.groups, function(gIdx, gRow) {
			//console.log($("#input_area_fieldset1 legend").text())
			//console.log("#input_area_fieldset" + group[0] + " legend")
		    //console.log($("#input_area_fieldset" + group[0] + " legend").text())
			//$("#input_area_box" + group[0] + " > legned").html("test");
			group_id = gRow[0];
			group_name = gRow[1];
			$("#input_area_fieldset" + group_id + " legend").html('&nbsp;' + group_name + '&nbsp;');
			
			var html = '';
			html += '<div>';
			html += '<input type="checkbox" id="input_area' + group_id + '_check0" name="input_area' + group_id + '_checkall" value="ALL">';
			html +=	'<label for="input_area1_check0"> ALL</label>';
			html += '</div>';
			seq = 0;
			$.each(app.codebook, function(idx, row) {
				if (idx == 0) return true;        // continue
				//if (idx > 5) return false;        // break
				serial = row[p_serial];
				code = row[p_code];
				groupid = row[p_groupid];
				web_system = row[p_web_system];
				description_short_name = row[p_description_short_name];
				if (groupid != group_id) return true;        // continue
				if (web_system != 1) return true;        // continue
				seq += 1;
				seq00 = zeroPad(seq, 2);
				//console.log(serial, groupid+'-'+seq00, code, web_system, description_short_name);
				html += '<div>';
				html += '<input type="checkbox" id="input_area' + group_id + '_check' + seq + '" name="input_area' + group_id + '_checkboxes" value="' + group_id+'-'+seq00 + ' ' + code + '">';
				//html +=	'<label style="color:black" for="input_area' + group_id + '_check' + seq + '"> ' + description_short_name + '</label>';
				html +=	'<label for="input_area' + group_id + '_check' + seq + '"> ' + description_short_name + '</label>';
				html += '</div>';
				//console.log(description_short_name);
			});
			//console.log(html);
			$("#input_area_items" + group_id).html(html);
			
			$("#input_area" + group_id + "_check0").change(function(){     // ALL
				//console.log(this.id);
				checkboxes = this.id.replace("_check0", "_checkboxes");    // input_area1_check0 -> input_area1_checkboxes
				//console.log("input[name=" + checkboxes + "]");
				if($(this).is(':checked')) {
					//$("input[name=" + checkboxes + "]:checkbox").prop("checked", true);
					$("input[name=" + checkboxes + "]").prop("checked", true);
					//$("input[name=" + checkboxes + "]").each(function() {
						//console.log( this.value + ":" + this.checked );
					//	this.checked = true;
					//});
				} else {
					//$("input[name=" + checkboxes + "]:checkbox").prop("checked", false);
					$("input[name=" + checkboxes + "]").prop("checked", false);
					//$("input[name=" + checkboxes + "]").each(function() {
						//console.log( this.value + ":" + this.checked );
					//	this.checked = false;
					//});
				}
			});
		});
		changeLabelColor_quadrbox();
	});
	//}).error(function(error) { console.log(error.responseText); });
	
	//<button id="downloadCSV" type="submit" style="float:right">Download CSV</button>	
	$("#downloadCSV").click(function() {
		params = "";
		$.each(app.groups, function(gIdx, gRow) {
			group_id = gRow[0];
			group_name = gRow[1];
			//$("#input_area_fieldset" + group_id + " legend").html('&nbsp;' + group_name + '&nbsp;');
			$("input[name=input_area" + group_id + "_checkboxes]").each(function() {
				if (this.checked) {
					params += this.value + ',';
					//console.log(this.value);
				}
			});
		});
		//console.log(params);
		if (params.length == 0) {
			swal({
				title: "Attention!",
				text: "You have not selected any of socioeconomic and demographic variables. Please select at least one check box.",
				icon: "warning",
				button: "GO BACK",
			});
			//alert("You have not selected any variable.\n Please check scioeconomic and demographic variables to download");
			return;
		} else params = params.substring(0, params.length-1);
		
		app.year = $("select[name=year]").val();           // save year to global variable
		app.state = $("select[name=state]").val();         // save state to global variable
		app.metro = $("select[name=metro]").val();         // save metro to global variable
		app.county = $("select[name=county]").val();       // save county to global variable
		var statename = $("select[name=state] option:selected").text();
		var metroname = $("select[name=metro] option:selected").text();
		var countyame = $("select[name=county] option:selected").text();
		//console.log(statename);
		
		$("#ajaxBusy").show();
		$.getJSON('python/getLNAnalysis.py', {'year':app.year, 'state':app.state, 'metro':app.metro, 'county':app.county, 
			'codes':params, 'statename':statename, 'metroname':metroname, 'countyame':countyame}, function(msg) {
			$("#ajaxBusy").hide();
			var filename = msg['filename'];
			var result = msg['result'];
			//csv = 'data:text/csv;charset=utf-8,';
			csv = '';
			$.each(result, function(rIdx, row) {
				$.each(row, function(cIdx, col) {
					csv += '"' + col + '",';
				});
				csv += '\n';
			});
			//console.log("CSV Download started: "+filename);
			
			var data = encodeURI(csv);
			downloadFile(csv, filename)
			//console.log(data);
			//var link = document.createElement('a');
			//link.setAttribute('href', data);
			//link.setAttribute('download', filename);
			//link.click();
			//document.body.removeChild(link);
		}); 
	});
	
	$("#submitForm").click(function() {
		
		document.getElementById("map_change").innerHTML = "";
		document.getElementById("map_class").innerHTML = "";
		
		var statename = $("select[name=state] option:selected").text();
		var metroname = $("select[name=metro] option:selected").text();
		var countyame = $("select[name=county] option:selected").text();

		//console.log(app.metro);
		if (app.metro == "ALL") 
		{
			swal({
				title: "Attention!",
				text: "Please select a metro area. Your map will be drawn within the selected metro area.",
				icon: "warning",
				button: "GO BACK",
			});		
			return;
        }
		
		// clear drop-down list of 'Select Layer:' 
		document.getElementById("map_change").innerHTML = '';
		
		// count checked params from four groups
		params = "";
		$.each(app.groups, function(gIdx, gRow) {
			group_id = gRow[0];
			group_name = gRow[1];
			$("input[name=input_area" + group_id + "_checkboxes]").each(function() {
				if (this.checked) {
					params += this.value + ',';					
				}
			});
		});
		if (params.length == 0) 
		{
			swal({
				title: "Attention!",
				text: "You have not selected any of socioeconomic and demographic variables. Please select at least one check box.",
				icon: "warning",
				button: "GO BACK",
			});
			return;
		} else params = params.substring(0, params.length-1);	
	
		
		if (map) map.remove();
		map = L.map('map0').setView([37.09024, -95.712891], 4);
		L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
			maxZoom: 20,
			attribution:'<a href="http://spatial.ucr.edu/">Center for Geospatial Sciences</a>, ',
			id: 'mapbox.light'
		}).addTo(map);

		var layersControl = new L.Control.Layers({
			//'CloudMade': cloudmade
		}, {
			//'Some marker': marker,
			//'vector layer': geojson
		});	

				
		console.log('year: '+app.year);
		console.log('state: '+app.state);
		console.log('metro: '+app.metro);
		console.log('county: '+app.county);
		console.log('codes: '+params);
		console.log('statename: '+statename);
		console.log('metroname: '+metroname);
		console.log('countyame: '+countyame);

		// request to server
		$("#ajaxBusy").show();
		$.getJSON('python/mapLNAnalysis.py', {'year':app.year, 'state':app.state, 'metro':app.metro, 'county':app.county, 
			'codes':params, 'statename':statename, 'metroname':metroname, 'countyame':countyame}, function(msg) {
			$("#ajaxBusy").hide();
			var filename = msg['filename'];
			var result = msg['result'];
			//csv = 'data:text/csv;charset=utf-8,';
			//csv = '';
			console.log(result)
			title = result[0];
			GEO_JSON = {"type":"FeatureCollection", "features":[]}
			$.each(result, function(rIdx, row) {
				if (rIdx == 0) return true;
				//console.log(row[0], row[1], row[2], row[3], row[4].substring(0,5));
				tractid = row[0];
				geojson = JSON.parse(row[4]);
				//console.log(geojson)
				feature = {"type":"Feature","geometry":{},"properties":{}};
				//geometry = feature["geometry"];
				feature["geometry"] = geojson["geometry"]
				properties = feature["properties"];
				properties["tractid"] = tractid;
				$.each(row, function(cIdx, col) {
					if (cIdx < 5) return true;
					properties[title[cIdx]] = row[cIdx];
				});
				//console.log(feature);
				GEO_JSON["features"].push(feature);
				//console.log(d3.geoBounds(feature));
				//return false;
				//return false;
				//$.each(row, function(cIdx, col) {
				//	csv += '"' + col + '",';
				//});
				//csv += '\n';
			});
			console.log(GEO_JSON);
			
			// set drop-down list of 'Select Layer:' 
			var html = 'Select Layer: <select name="ACSdata" onChange="layerChange()">';
			$.each(app.groups, function(gIdx, gRow) {
				group_id = gRow[0];
				group_name = gRow[1];
				$("input[name=input_area" + group_id + "_checkboxes]").each(function() {
					if (this.checked) {
						html += '<option value="' + this.value + '">' + $($(this).prop('labels')).text() + '</option>';	
						//console.log($($(this).prop('labels')).text());						
					}
				});
			});
			html += '</select>' 
			document.getElementById("map_change").innerHTML = html;
	
			// set drop-down list of 'Select Classification:' 
			var html_class = '<form name="classSelect" action=""> ' +
							'<span id="class_change">Select: </span>' +
							'<select name="classified" onChange="layerChange()">' +
							'<option value="equal">Equal Classification</option>' +
							'<option value="quantile" selected>Quantile Classification</option>' + 
							'</select></form>';	
			document.getElementById("map_class").innerHTML = html_class;
			
			var bounds = d3.geoBounds(GEO_JSON);
			console.log(bounds);
			//map.fitBounds([
			//	[40.712, -74.227],
			//	[40.774, -74.125]
			//]);
			if (bounds[0][1] && bounds[0][0] && bounds[1][1] && bounds[1][0]) {
				var nLon = bounds[1][0] - bounds[0][0]
				var nLat = bounds[1][1] - bounds[0][1]
				dLon = nLon * 0.1;               // shrink the bounds of longitude 20% (10% + 10%)
				dLat = nLat * 0.1;               // shrink the bounds of latitude  20% (10% + 10%)
				fitBounds = [[bounds[0][1]+dLat, bounds[0][0]+dLon], [bounds[1][1]-dLat, bounds[1][0]-dLon]]
				console.log(fitBounds);
				map.fitBounds(fitBounds);
			}
			CA = GEO_JSON;
			
			layerChange();
		}); 
/*		
		// set drop-down list of 'Select Layer:' 
		var html = 'Select Layer: <select name="ACSdata" onChange="layerChange()">';
		$.each(app.groups, function(gIdx, gRow) {
			group_id = gRow[0];
			group_name = gRow[1];
			$("input[name=input_area" + group_id + "_checkboxes]").each(function() {
				if (this.checked) {
					html += '<option value="' + this.value + '">' + $($(this).prop('labels')).text() + '</option>';	
					//console.log($($(this).prop('labels')).text());						
				}
			});
		});
		html += '</select>' 
		document.getElementById("map_change").innerHTML = html;
		
		document.getElementById("input_selected").innerHTML = "<strong>Selected Variables: </strong>" + 
		params + "<br><br>" + 
		"<strong> Selected Regions: </strong>" + statename + "<font color='blue'> states, </font>" + metroname + "<font color='blue'> metropolitan area(s),  </font>" + countyame + "<font color='blue'> county(ies)  </font>" + "<br><br>";

		var html_class = '<form name="classSelect" action=""> ' +
						 '<span id="class_change">Select: </span>' +
						 '<select name="classified" onChange="layerChange()">' +
						 '<option value="equal">Equal Classification</option>' +
						 '<option value="quantile" selected>Quantile Classification</option>' + 
						 '</select></form>';	
		document.getElementById("map_class").innerHTML = html_class;	

		var html_exMAP = '<form name="layerSelect" action=""><span id="layer_change">Select Layer: ( It will be removed. ) </span> ' +
		'<select name="ACSdata" onChange="layerChange()">' +	
		'<option value="HC01_VC04">Population 16 years and over</option>' +
		'<option value="HC01_VC20">Own children under 6 years</option>' +
		'<option value="HC01_VC21">All parents in family in labor force</option>' +
		'<option value="HC01_VC23">Own children 6 to 17 years</option>' +
		'<option value="HC01_VC28">Workers 16 years and over</option>' +
		'<option value="HC01_VC74">Total households</option>' +
		'<option value="HC01_VC85">Median household income</option>' +
		'<option value="HC01_VC86">Mean household income</option>' +
		'<option value="HC01_VC112">Median family income</option>' +
		'<option value="HC01_VC113">Mean family income</option>' +
		'<option value="HC01_VC115">Per capita income</option></select></form>';
		'<option value="poverty70">% in poverty, total 1970</option>' +
		'<option value="poverty80">% in poverty, total 1980</option>' +
		'<option value="poverty90">% in poverty, total 1990</option>' +
		'<option value="poverty00">% in poverty, total 2000</option>' +		
		'<option value="poverty10">% in poverty, total 2010</option></select></form>';
		//document.getElementById("example_map").innerHTML = html_exMAP;	
*/		
	});
	
	
});


// set options items in select name="metro"
function set_metro_options() {
	var state = $("select[name=state]").val();            // get selected state from document
	var statid = state.substring(0,2);
	//console.log($("select[name=state] option:selected").text());
	$.getJSON('python/getMetro.py', {stateid: statid}, function(msg) {
		var metros = msg['metros']
		//html = '<option value="ALL">All county of ' + $("select[name=state] option:selected").text() + '</option>';
		html = '<option value="ALL">All</option>';
		$.each(metros, function(idx, row) {  
			var stateid = row[0];
			var metroid = row[1];
			var state = row[2];
			var metroname = row[3];
			html += '<option value="' + metroid + '">' + metroname + '</option>';
		});
		$("select[name=metro]").html(html);
		app.metro = 'ALL';
		set_county_options();
	});
}


// set options items in select name="county"
function set_county_options() {
	var state = $("select[name=state]").val();            // get selected state from document
	var statid = state.substring(0,2);
	var metroid = $("select[name=metro]").val();           // get selected state from document
	//console.log($("select[name=state] option:selected").text());
	$.getJSON('python/getCounty.py', {stateid: statid, metroid: metroid}, function(msg) {
		var counties = msg['counties']
		html = '';
		//if (counties.length > 1) 
		html = '<option value="ALL">All</option>';
		$.each(counties, function(idx, row) {  
			var countyid = row[0];
			var countyname = row[1];
			html += '<option value="' + countyid + '">' + countyname + '</option>';
		});
		$("select[name=county]").html(html);
		app.county = 'ALL';
	});
	
}


// function to download large CSV. Worked in IE/Firefox/Chrome
function downloadFile(data, filename) {
    var csvData = data;
    var blob = new Blob([ csvData ], {
        type : "application/csv;charset=utf-8;"
    });

    if (window.navigator.msSaveBlob) {           // FOR IE BROWSER
        navigator.msSaveBlob(blob, filename);
    } else {                                     // FOR OTHER BROWSERS    
        var link = document.createElement("a");
        var csvUrl = URL.createObjectURL(blob);
        link.href = csvUrl;
        link.style = "visibility:hidden";
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
}


// Change label color of quadrbox by year
function changeLabelColor_quadrbox() {
	if (!app.year || !app.groups || !app.codebook) return;
	//console.log($(this).style());
	
	var p_serial = app.codebook[0].indexOf('serial');
	var p_code = app.codebook[0].indexOf('code');
	var p_descritpion = app.codebook[0].indexOf('descritpion');
	var p_year1970 = app.codebook[0].indexOf('year1970');
	var p_year1980 = app.codebook[0].indexOf('year1980');
	var p_year1990 = app.codebook[0].indexOf('year1990');
	var p_year2000 = app.codebook[0].indexOf('year2000');
	var p_year2010 = app.codebook[0].indexOf('year2010');
	var p_year2012 = app.codebook[0].indexOf('year2012');
	var p_groupid = app.codebook[0].indexOf('groupid');
	var p_web_system = app.codebook[0].indexOf('web_system');
	var p_description_short_name = app.codebook[0].indexOf('description_short_name');
	var p_description_full_name = app.codebook[0].indexOf('description_full_name');
	var p_denominator1970 = app.codebook[0].indexOf('denominator1970');
	var p_denominator1980 = app.codebook[0].indexOf('denominator1980');
	var p_denominator1990 = app.codebook[0].indexOf('denominator1990');
	var p_denominator2000 = app.codebook[0].indexOf('denominator2000');
	var p_denominator2010 = app.codebook[0].indexOf('denominator2010');
	var p_denominator2012 = app.codebook[0].indexOf('denominator2012');
	
	$.each(app.groups, function(gIdx, gRow) {
		group_id = gRow[0];
		group_name = gRow[1];
		
		// Reset all of the label color to black
		$("input[name='input_area" + group_id + "_checkboxes']").each(function(index) {
			$("label[for='" + $(this).attr('id') + "']").css('text-decoration', 'none');
		});
		
		// Change the label color to gray, if the numerator not found in the year
		p = ["1970", "1980", "1990", "2000", "2010", "2012"].indexOf(app.year) + p_year1970;
		
		//console.log(app.codebook[10][p]);
		seq = 0;
		$.each(app.codebook, function(idx, row) {
			if (idx == 0) return true;        // continue
			//if (idx > 5) return false;        // break
			serial = row[p_serial];
			code = row[p_code];
			groupid = row[p_groupid];
			web_system = row[p_web_system];
			description_short_name = row[p_description_short_name];
			if (groupid != group_id) return true;        // continue
			if (web_system != 1) return true;        // continue
			seq += 1;
			seq00 = zeroPad(seq, 2);
			//console.log(serial, code, groupid, row[p]);
			if (row[p]) return true;        // continue
			
			var id = "input_area"+group_id+"_check" + seq;    // input_area1_check1
			//console.log('"'+description_short_name+'"');
			//console.log('"'+$("label[for='"+id+"']").text().trim()+'"');
			if (description_short_name != $("label[for='"+id+"']").text().trim()) return true;
			//console.log(serial, code, groupid+'-'+seq, description_short_name);
			$("label[for='"+id+"']").css('text-decoration', 'line-through');
		});
		
	});
}


// Pading a value with leading zeors
function zeroPad(num, places) {
  var zero = places - num.toString().length + 1;
  return Array(+(zero > 0 && zero)).join("0") + num;
}
	</script>
</body>
</html>
